/**
 * GNU GENERAL PUBLIC LICENSE
 * Version 2, June 1991
 * <p/>
 * Copyright (C) 1989, 1991 Free Software Foundation, Inc., <http://fsf.org/>
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
 * Everyone is permitted to copy and distribute verbatim copies
 * of this license document, but changing it is not allowed.
 * <p/>
 * Preamble
 * <p/>
 * The licenses for most software are designed to take away your
 * freedom to share and change it.  By contrast, the GNU General Public
 * License is intended to guarantee your freedom to share and change free
 * software--to make sure the software is free for all its users.  This
 * General Public License applies to most of the Free Software
 * Foundation's software and to any other program whose authors commit to
 * using it.  (Some other Free Software Foundation software is covered by
 * the GNU Lesser General Public License instead.)  You can apply it to
 * your programs, too.
 * <p/>
 * When we speak of free software, we are referring to freedom, not
 * price.  Our General Public Licenses are designed to make sure that you
 * have the freedom to distribute copies of free software (and charge for
 * this service if you wish), that you receive source code or can get it
 * if you want it, that you can change the software or use pieces of it
 * in new free programs; and that you know you can do these things.
 * <p/>
 * To protect your rights, we need to make restrictions that forbid
 * anyone to deny you these rights or to ask you to surrender the rights.
 * These restrictions translate to certain responsibilities for you if you
 * distribute copies of the software, or if you modify it.
 * <p/>
 * For example, if you distribute copies of such a program, whether
 * gratis or for a fee, you must give the recipients all the rights that
 * you have.  You must make sure that they, too, receive or can get the
 * source code.  And you must show them these terms so they know their
 * rights.
 * <p/>
 * We protect your rights with two steps: (1) copyright the software, and
 * (2) offer you this license which gives you legal permission to copy,
 * distribute and/or modify the software.
 * <p/>
 * Also, for each author's protection and ours, we want to make certain
 * that everyone understands that there is no warranty for this free
 * software.  If the software is modified by someone else and passed on, we
 * want its recipients to know that what they have is not the original, so
 * that any problems introduced by others will not reflect on the original
 * authors' reputations.
 * <p/>
 * Finally, any free program is threatened constantly by software
 * patents.  We wish to avoid the danger that redistributors of a free
 * program will individually obtain patent licenses, in effect making the
 * program proprietary.  To prevent this, we have made it clear that any
 * patent must be licensed for everyone's free use or not licensed at all.
 * <p/>
 * The precise terms and conditions for copying, distribution and
 * modification follow.
 * <p/>
 * GNU GENERAL PUBLIC LICENSE
 * TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
 * <p/>
 * 0. This License applies to any program or other work which contains
 * a notice placed by the copyright holder saying it may be distributed
 * under the terms of this General Public License.  The "Program", below,
 * refers to any such program or work, and a "work based on the Program"
 * means either the Program or any derivative work under copyright law:
 * that is to say, a work containing the Program or a portion of it,
 * either verbatim or with modifications and/or translated into another
 * language.  (Hereinafter, translation is included without limitation in
 * the term "modification".)  Each licensee is addressed as "you".
 * <p/>
 * Activities other than copying, distribution and modification are not
 * covered by this License; they are outside its scope.  The act of
 * running the Program is not restricted, and the output from the Program
 * is covered only if its contents constitute a work based on the
 * Program (independent of having been made by running the Program).
 * Whether that is true depends on what the Program does.
 * <p/>
 * 1. You may copy and distribute verbatim copies of the Program's
 * source code as you receive it, in any medium, provided that you
 * conspicuously and appropriately publish on each copy an appropriate
 * copyright notice and disclaimer of warranty; keep intact all the
 * notices that refer to this License and to the absence of any warranty;
 * and give any other recipients of the Program a copy of this License
 * along with the Program.
 * <p/>
 * You may charge a fee for the physical act of transferring a copy, and
 * you may at your option offer warranty protection in exchange for a fee.
 * <p/>
 * 2. You may modify your copy or copies of the Program or any portion
 * of it, thus forming a work based on the Program, and copy and
 * distribute such modifications or work under the terms of Section 1
 * above, provided that you also meet all of these conditions:
 * <p/>
 * a) You must cause the modified files to carry prominent notices
 * stating that you changed the files and the date of any change.
 * <p/>
 * b) You must cause any work that you distribute or publish, that in
 * whole or in part contains or is derived from the Program or any
 * part thereof, to be licensed as a whole at no charge to all third
 * parties under the terms of this License.
 * <p/>
 * c) If the modified program normally reads commands interactively
 * when run, you must cause it, when started running for such
 * interactive use in the most ordinary way, to print or display an
 * announcement including an appropriate copyright notice and a
 * notice that there is no warranty (or else, saying that you provide
 * a warranty) and that users may redistribute the program under
 * these conditions, and telling the user how to view a copy of this
 * License.  (Exception: if the Program itself is interactive but
 * does not normally print such an announcement, your work based on
 * the Program is not required to print an announcement.)
 * <p/>
 * These requirements apply to the modified work as a whole.  If
 * identifiable sections of that work are not derived from the Program,
 * and can be reasonably considered independent and separate works in
 * themselves, then this License, and its terms, do not apply to those
 * sections when you distribute them as separate works.  But when you
 * distribute the same sections as part of a whole which is a work based
 * on the Program, the distribution of the whole must be on the terms of
 * this License, whose permissions for other licensees extend to the
 * entire whole, and thus to each and every part regardless of who wrote it.
 * <p/>
 * Thus, it is not the intent of this section to claim rights or contest
 * your rights to work written entirely by you; rather, the intent is to
 * exercise the right to control the distribution of derivative or
 * collective works based on the Program.
 * <p/>
 * In addition, mere aggregation of another work not based on the Program
 * with the Program (or with a work based on the Program) on a volume of
 * a storage or distribution medium does not bring the other work under
 * the scope of this License.
 * <p/>
 * 3. You may copy and distribute the Program (or a work based on it,
 * under Section 2) in object code or executable form under the terms of
 * Sections 1 and 2 above provided that you also do one of the following:
 * <p/>
 * a) Accompany it with the complete corresponding machine-readable
 * source code, which must be distributed under the terms of Sections
 * 1 and 2 above on a medium customarily used for software interchange; or,
 * <p/>
 * b) Accompany it with a written offer, valid for at least three
 * years, to give any third party, for a charge no more than your
 * cost of physically performing source distribution, a complete
 * machine-readable copy of the corresponding source code, to be
 * distributed under the terms of Sections 1 and 2 above on a medium
 * customarily used for software interchange; or,
 * <p/>
 * c) Accompany it with the information you received as to the offer
 * to distribute corresponding source code.  (This alternative is
 * allowed only for noncommercial distribution and only if you
 * received the program in object code or executable form with such
 * an offer, in accord with Subsection b above.)
 * <p/>
 * The source code for a work means the preferred form of the work for
 * making modifications to it.  For an executable work, complete source
 * code means all the source code for all modules it contains, plus any
 * associated interface definition files, plus the scripts used to
 * control compilation and installation of the executable.  However, as a
 * special exception, the source code distributed need not include
 * anything that is normally distributed (in either source or binary
 * form) with the major components (compiler, kernel, and so on) of the
 * operating system on which the executable runs, unless that component
 * itself accompanies the executable.
 * <p/>
 * If distribution of executable or object code is made by offering
 * access to copy from a designated place, then offering equivalent
 * access to copy the source code from the same place counts as
 * distribution of the source code, even though third parties are not
 * compelled to copy the source along with the object code.
 * <p/>
 * 4. You may not copy, modify, sublicense, or distribute the Program
 * except as expressly provided under this License.  Any attempt
 * otherwise to copy, modify, sublicense or distribute the Program is
 * void, and will automatically terminate your rights under this License.
 * However, parties who have received copies, or rights, from you under
 * this License will not have their licenses terminated so long as such
 * parties remain in full compliance.
 * <p/>
 * 5. You are not required to accept this License, since you have not
 * signed it.  However, nothing else grants you permission to modify or
 * distribute the Program or its derivative works.  These actions are
 * prohibited by law if you do not accept this License.  Therefore, by
 * modifying or distributing the Program (or any work based on the
 * Program), you indicate your acceptance of this License to do so, and
 * all its terms and conditions for copying, distributing or modifying
 * the Program or works based on it.
 * <p/>
 * 6. Each time you redistribute the Program (or any work based on the
 * Program), the recipient automatically receives a license from the
 * original licensor to copy, distribute or modify the Program subject to
 * these terms and conditions.  You may not impose any further
 * restrictions on the recipients' exercise of the rights granted herein.
 * You are not responsible for enforcing compliance by third parties to
 * this License.
 * <p/>
 * 7. If, as a consequence of a court judgment or allegation of patent
 * infringement or for any other reason (not limited to patent issues),
 * conditions are imposed on you (whether by court order, agreement or
 * otherwise) that contradict the conditions of this License, they do not
 * excuse you from the conditions of this License.  If you cannot
 * distribute so as to satisfy simultaneously your obligations under this
 * License and any other pertinent obligations, then as a consequence you
 * may not distribute the Program at all.  For example, if a patent
 * license would not permit royalty-free redistribution of the Program by
 * all those who receive copies directly or indirectly through you, then
 * the only way you could satisfy both it and this License would be to
 * refrain entirely from distribution of the Program.
 * <p/>
 * If any portion of this section is held invalid or unenforceable under
 * any particular circumstance, the balance of the section is intended to
 * apply and the section as a whole is intended to apply in other
 * circumstances.
 * <p/>
 * It is not the purpose of this section to induce you to infringe any
 * patents or other property right claims or to contest validity of any
 * such claims; this section has the sole purpose of protecting the
 * integrity of the free software distribution system, which is
 * implemented by public license practices.  Many people have made
 * generous contributions to the wide range of software distributed
 * through that system in reliance on consistent application of that
 * system; it is up to the author/donor to decide if he or she is willing
 * to distribute software through any other system and a licensee cannot
 * impose that choice.
 * <p/>
 * This section is intended to make thoroughly clear what is believed to
 * be a consequence of the rest of this License.
 * <p/>
 * 8. If the distribution and/or use of the Program is restricted in
 * certain countries either by patents or by copyrighted interfaces, the
 * original copyright holder who places the Program under this License
 * may add an explicit geographical distribution limitation excluding
 * those countries, so that distribution is permitted only in or among
 * countries not thus excluded.  In such case, this License incorporates
 * the limitation as if written in the body of this License.
 * <p/>
 * 9. The Free Software Foundation may publish revised and/or new versions
 * of the General Public License from time to time.  Such new versions will
 * be similar in spirit to the present version, but may differ in detail to
 * address new problems or concerns.
 * <p/>
 * Each version is given a distinguishing version number.  If the Program
 * specifies a version number of this License which applies to it and "any
 * later version", you have the option of following the terms and conditions
 * either of that version or of any later version published by the Free
 * Software Foundation.  If the Program does not specify a version number of
 * this License, you may choose any version ever published by the Free Software
 * Foundation.
 * <p/>
 * 10. If you wish to incorporate parts of the Program into other free
 * programs whose distribution conditions are different, write to the author
 * to ask for permission.  For software which is copyrighted by the Free
 * Software Foundation, write to the Free Software Foundation; we sometimes
 * make exceptions for this.  Our decision will be guided by the two goals
 * of preserving the free status of all derivatives of our free software and
 * of promoting the sharing and reuse of software generally.
 * <p/>
 * NO WARRANTY
 * <p/>
 * 11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
 * FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
 * OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
 * PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
 * OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
 * TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
 * PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
 * REPAIR OR CORRECTION.
 * <p/>
 * 12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
 * WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
 * REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
 * INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
 * OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
 * TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
 * YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
 * PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGES.
 * <p/>
 * END OF TERMS AND CONDITIONS
 * <p/>
 * How to Apply These Terms to Your New Programs
 * <p/>
 * If you develop a new program, and you want it to be of the greatest
 * possible use to the public, the best way to achieve this is to make it
 * free software which everyone can redistribute and change under these terms.
 * <p/>
 * To do so, attach the following notices to the program.  It is safest
 * to attach them to the start of each source file to most effectively
 * convey the exclusion of warranty; and each file should have at least
 * the "copyright" line and a pointer to where the full notice is found.
 * <p/>
 * {description}
 * Copyright (C) {year}  {fullname}
 * <p/>
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * <p/>
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * <p/>
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 * <p/>
 * Also add information on how to contact you by electronic and paper mail.
 * <p/>
 * If the program is interactive, make it output a short notice like this
 * when it starts in an interactive mode:
 * <p/>
 * Gnomovision version 69, Copyright (C) year name of author
 * Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
 * This is free software, and you are welcome to redistribute it
 * under certain conditions; type `show c' for details.
 * <p/>
 * The hypothetical commands `show w' and `show c' should show the appropriate
 * parts of the General Public License.  Of course, the commands you use may
 * be called something other than `show w' and `show c'; they could even be
 * mouse-clicks or menu items--whatever suits your program.
 * <p/>
 * You should also get your employer (if you work as a programmer) or your
 * school, if any, to sign a "copyright disclaimer" for the program, if
 * necessary.  Here is a sample; alter the names:
 * <p/>
 * Yoyodyne, Inc., hereby disclaims all copyright interest in the program
 * `Gnomovision' (which makes passes at compilers) written by James Hacker.
 * <p/>
 * {signature of Ty Coon}, 1 April 1989
 * Ty Coon, President of Vice
 * <p/>
 * This General Public License does not permit incorporating your program into
 * proprietary programs.  If your program is a subroutine library, you may
 * consider it more useful to permit linking proprietary applications with the
 * library.  If this is what you want to do, use the GNU Lesser General
 * Public License instead of this License.
 */
package org.fao.faostat.api.legacy;

import org.apache.commons.lang3.StringEscapeUtils;
import org.apache.log4j.Logger;
import org.fao.faostat.api.core.FAOSTATAPICore;
import org.fao.faostat.api.core.StreamBuilder;
import org.fao.faostat.api.core.beans.DataBean;
import org.fao.faostat.api.core.beans.DatasourceBean;
import org.fao.faostat.api.core.beans.MetadataBean;
import org.fao.faostat.api.core.beans.OutputBean;
import org.fao.faostat.api.core.constants.DATASOURCE;
import org.fao.faostat.api.core.constants.QUERIES;
import org.fao.faostat.api.core.jdbc.JDBCIterable;
import org.fao.faostat.api.web.utils.FAOSTATAPIUtils;
import org.springframework.stereotype.Component;

import javax.ws.rs.*;
import javax.ws.rs.core.*;
import java.io.*;
import java.util.*;

/**
 * @author <a href="mailto:guido.barbaglia@gmail.com">Guido Barbaglia</a>
 */
@Component
@Path("/{lang}/data")
//@Produces(MediaType.APPLICATION_JSON + ";charset=utf-8")
public class V10Data {

    private static final Logger LOGGER = Logger.getLogger(V10Data.class);

    @Context
    UriInfo uri;

    @POST
    //    @Path("/bean/")
    public Response getDataFromBean(@PathParam("lang") String lang, DataBean b) {

        /* Logger. */
        StringBuilder log = new StringBuilder();

        /* Init Core library. */
        FAOSTATAPICore faostatapiCore = new FAOSTATAPICore();

        /* Datasource bean. */
        DatasourceBean datasourceBean = new DatasourceBean(DATASOURCE.valueOf(b.getDatasource().toUpperCase()));

        /* Store user preferences. */
        MetadataBean metadataBean = new MetadataBean();
        metadataBean.storeUserOptions(b.getDatasource(), b.getApi_key(), b.getClient_key(), b.getOutput_type());
        metadataBean.addParameter("lang", faostatapiCore.iso2faostat(lang));
        metadataBean.addParameter("domain_codes", b.getDomain_codes());
        metadataBean.addParameter("domain_code", b.getDomain_codes().get(0)); /* Get the first domain code, to get the dimensions later on. */

        /* Init filters. */
        Map<String, List<String>> filters = new HashMap<>();
        filters.put("List1Codes", new ArrayList<String>());
        filters.put("List2Codes", new ArrayList<String>());
        filters.put("List3Codes", new ArrayList<String>());
        filters.put("List4Codes", new ArrayList<String>());
        filters.put("List5Codes", new ArrayList<String>());
        filters.put("List6Codes", new ArrayList<String>());
        filters.put("List7Codes", new ArrayList<String>());

        /* Init filters. Conding Systems */
        /* TODO: to be implemented with the mapping */
        Map<String, String> filtersCS = new HashMap<>();
        filtersCS.put("List1AltCodes", "");
        filtersCS.put("List2AltCodes", "");
        filtersCS.put("List3AltCodes", "");
        filtersCS.put("List4AltCodes", "");
        filtersCS.put("List5AltCodes", "");
        filtersCS.put("List6AltCodes", "");
        filtersCS.put("List7AltCodes", "");

        /* Get user dimensions. */
        List<String> dimensions = new ArrayList<>();
        for (String key : b.getFilters().keySet()) {
            LOGGER.info("Filter:" + key);
            dimensions.add(key);
        }

        /* Get dimensions. */
        try {

            /* add report_code dimension (this is used for the query) */
            metadataBean.addParameter("report_code", "download");
            metadataBean.setFull(true);

            // TODO: this should be checked with performance
            /* if a dimension is not passed, all the other codes are taken */
            List<String> defaultCodes = new ArrayList<String>();
            defaultCodes.add("_1");

            /* getting domain dimensions */
            OutputBean ob = faostatapiCore.queryDimensions("dimensions", datasourceBean, metadataBean);

            /* Check if at least one filter is passed */
            boolean validFilter = false;

            /* for each dimension tries to map to a filter */
            while (ob.getData().hasNext()) {

                Map<String, Object> m = ob.getData().next();
                String id = m.get("id").toString();
                String parameter = m.get("parameter").toString();

                LOGGER.info("ID: " + id + " - Parameter: " + parameter);

                /* check mapping filter on dimension id */
                if (b.getFilters().get(id) != null) {
                    filters.put(parameter, b.getFilters().get(id));
                    validFilter = true;
                    continue;
                } else {
                    // TODO: this should be checked with performance
                    /* adding the default codes */
                    filters.put(parameter, defaultCodes);
                }

                LOGGER.info("Filters: " + filters);

                /* check mapping filter on subdimension id */
                if (m.get("subdimensions") != null) {

                    ArrayList<Map<String, Object>> l = (ArrayList<Map<String, Object>>) m.get("subdimensions");
                    for (Map<String, Object> m2 : l) {
                        id = m2.get("id").toString();
                        parameter = m2.get("parameter").toString();
                        /* append filters */
                        if (b.getFilters().get(id) != null) {
                            filters.put(parameter, b.getFilters().get(id));
                        }
                    }
                }
            }

            if (!validFilter) {
                LOGGER.warn("Invalid request. Please add at least one filter.");
                throw new Exception("Please add at least one filter.");
            }

            LOGGER.info("Calling getData function");

            return getData(lang, b.getDomain_codes(), b.getDatasource(), b.getApi_key(), b.getClient_key(), b.getOutput_type(),
                    filters.get("List1Codes"),
                    filters.get("List2Codes"),
                    filters.get("List3Codes"),
                    filters.get("List4Codes"),
                    filters.get("List5Codes"),
                    filters.get("List6Codes"),
                    filters.get("List7Codes"),
                    filtersCS.get("List1AltCodes"),
                    filtersCS.get("List2AltCodes"),
                    filtersCS.get("List3AltCodes"),
                    filtersCS.get("List4AltCodes"),
                    filtersCS.get("List5AltCodes"),
                    filtersCS.get("List6AltCodes"),
                    filtersCS.get("List7AltCodes"),
                    b.getGroup_by(), b.getOrder_by(), b.getOperator(),
                    b.getPage_size(), b.getDecimal_places(), b.getPage_number(), b.getLimit(),
                    b.isNull_values(), b.getShow_codes(), b.getShow_flags(), b.getShow_unit(),
                    b.isPivot()
            );

        } catch (WebApplicationException e) {
            return e.getResponse();
        } catch (Exception e) {
            return Response.status(500).entity(e.getMessage()).build();
        }
    }

    @POST
    @Path("/bean/")
    public Response getData(@PathParam("lang") String lang,
                            @FormParam("domain_codes") List<String> domain_codes,
                            @FormParam("datasource") final String datasource,
                            @FormParam("api_key") String api_key,
                            @FormParam("client_key") String client_key,
                            @FormParam("output_type") String output_type,
                            @FormParam("List1Codes") List<String> list_1_codes,
                            @FormParam("List2Codes") List<String> list_2_codes,
                            @FormParam("List3Codes") List<String> list_3_codes,
                            @FormParam("List4Codes") List<String> list_4_codes,
                            @FormParam("List5Codes") List<String> list_5_codes,
                            @FormParam("List6Codes") List<String> list_6_codes,
                            @FormParam("List7Codes") List<String> list_7_codes,
                            @FormParam("List1AltCodes") String list_1_alt_codes,
                            @FormParam("List2AltCodes") String list_2_alt_codes,
                            @FormParam("List3AltCodes") String list_3_alt_codes,
                            @FormParam("List4AltCodes") String list_4_alt_codes,
                            @FormParam("List5AltCodes") String list_5_alt_codes,
                            @FormParam("List6AltCodes") String list_6_alt_codes,
                            @FormParam("List7AltCodes") String list_7_alt_codes,
                            @FormParam("group_by") String group_by,
                            @FormParam("order_by") String order_by,
                            @FormParam("operator") String operator,
                            @FormParam("page_size") int page_size,
                            @FormParam("decimal_places") int decimal_places,
                            @FormParam("page_number") int page_number,
                            @FormParam("limit") @DefaultValue("-1") int limit,
                            // TODO: convert it all to boolean and convert it into string?
                            @FormParam("null_values") boolean null_values,
                            @FormParam("show_codes") @DefaultValue("1") int show_codes,
                            @FormParam("show_flags") @DefaultValue("1") int show_flags,
                            @FormParam("show_unit") @DefaultValue("1") int show_unit,
                            @FormParam("pivot") @DefaultValue("false") boolean pivot) {

        long t0 = System.currentTimeMillis();

        /* Init Core library. */
        FAOSTATAPICore faostatapiCore = new FAOSTATAPICore();

        /* Store user preferences. */
        final MetadataBean metadataBean = new MetadataBean();
        metadataBean.storeUserOptions(datasource, api_key, client_key, output_type);

        /* Store procedure parameters. */
        metadataBean.addParameter("lang", faostatapiCore.iso2faostat(lang));
        metadataBean.addParameter("domain_codes", domain_codes);
        metadataBean.addParameter("List1Codes", list_1_codes);
        metadataBean.addParameter("List2Codes", list_2_codes);
        metadataBean.addParameter("List3Codes", list_3_codes);
        metadataBean.addParameter("List4Codes", list_4_codes);
        metadataBean.addParameter("List5Codes", list_5_codes);
        metadataBean.addParameter("List6Codes", list_6_codes);
        metadataBean.addParameter("List7Codes", list_7_codes);

        metadataBean.addParameter("List1AltCodes", list_1_alt_codes);
        metadataBean.addParameter("List2AltCodes", list_2_alt_codes);
        metadataBean.addParameter("List3AltCodes", list_3_alt_codes);
        metadataBean.addParameter("List4AltCodes", list_4_alt_codes);
        metadataBean.addParameter("List5AltCodes", list_5_alt_codes);
        metadataBean.addParameter("List6AltCodes", list_6_alt_codes);
        metadataBean.addParameter("List7AltCodes", list_7_alt_codes);

        metadataBean.addParameter("null_values", null_values);
        metadataBean.addParameter("group_by", group_by);
        metadataBean.addParameter("order_by", order_by);
        metadataBean.addParameter("operator", operator);
        metadataBean.addParameter("page_size", page_size);
        metadataBean.addParameter("decimal_places", decimal_places);
        metadataBean.addParameter("page_number", page_number);
        metadataBean.addParameter("limit", limit);
        metadataBean.addParameter("show_codes", show_codes);
        metadataBean.addParameter("show_flags", show_flags);
        metadataBean.addParameter("show_unit", show_unit);

        // setting pivot
        metadataBean.setPivot(Boolean.valueOf(pivot));

        /* Query the DB and return the results. */
        try {

            /* Stream builder. */
            final StreamBuilder sb = new StreamBuilder();

            /* Datasource bean. */
            DatasourceBean datasourceBean = new DatasourceBean(metadataBean.getDatasource());

            final List<Map<String, Object>> dsd = faostatapiCore.createDSD(datasourceBean, metadataBean);

            /* Query the DB and create an output stream. */
//            StreamingOutput stream = sb.createDataOutputStream(datasourceBean, metadataBean);

            String query = new QUERIES().getQuery("data", metadataBean.getProcedureParameters());

            final JDBCIterable it = new JDBCIterable();
            it.query(datasourceBean, query);

            // statistics
            long tf = System.currentTimeMillis();
            metadataBean.setProcessingTime(tf - t0);

            StreamingOutput stream = new StreamingOutput() {

                @Override
                public void write(OutputStream os) throws IOException, WebApplicationException {

                    /* Initiate the buffer writer. */
                    Writer writer = new BufferedWriter(new OutputStreamWriter(os));

                    /* Generate an array of objects of arrays. */
                    switch (metadataBean.getOutputType()) {
                        case CSV:

                            writeCSV(it, writer);
                            break;

                        default:

                            writeJSON(sb, metadataBean, dsd, it, writer);
                            break;

                    }

                    /* Flush the writer. */
                    writer.flush();

                    /* Close the writer. */
                    writer.close();

                }

            };

            /* Stream result */
            return Response.ok(stream).type(FAOSTATAPIUtils.outputType(metadataBean)).build();

        } catch (WebApplicationException e) {
            LOGGER.error(uri.getRequestUri());
            return e.getResponse();
        } catch (Exception e) {
            LOGGER.error(e.getMessage());
            return Response.status(500).entity(e.getMessage()).build();
        }

    }

    private void writeCSV(JDBCIterable it, Writer writer) throws IOException {

        /* Get Headers from Metadata */
        List<String> headers = it.getColumnNames();

        /* write headers */
        for (int i = 0; i < headers.size(); i += 1) {
            writer.write(StringEscapeUtils.escapeCsv(headers.get(i)));
            if (i < headers.size() - 1)
                writer.write(",");
            else
                writer.write("\n");
        }

        /* Add CSV rows. */
        while (it.hasNext()) {
            writer.write(it.nextCSV());
        }

    }

    private void writeJSON(StreamBuilder sb, MetadataBean metadataBean, List<Map<String, Object>> dsd, JDBCIterable it, Writer writer) throws IOException {

        /* Initiate the output. */
        writer.write("{");

        /* Add metadata. */
        metadataBean.setDsd(dsd);
        writer.write(sb.createMetadata(metadataBean));

                            /* Initiate Data the array. */
        writer.write("\"data\": [");

        while (it.hasNext()) {
            writer.write(it.nextJSON());
            if (it.hasNext()) {
                writer.write(",");
            }
        }

        /* Close the array. */
        writer.write("]");

        /* Close the object. */
        writer.write("}");

    }


    @GET
    @Path("/{domain}")
    public Response getData(@PathParam("lang") String lang,
                            @PathParam("domain") final String domainCode,
                            @QueryParam("datasource") @DefaultValue("production") String datasource,
                            @QueryParam("api_key") String api_key,
                            @QueryParam("client_key") String client_key,
                            @QueryParam("output_type") String output_type,
                            @QueryParam("group_by") @DefaultValue("") String group_by,
                            @QueryParam("order_by") @DefaultValue("") String order_by,
                            @QueryParam("operator") @DefaultValue("") String operator,
                            @QueryParam("decimal_places") Integer decimal_places,
                            @QueryParam("page_size") @DefaultValue("0") Integer page_size,
                            @QueryParam("page_number") @DefaultValue("0") Integer page_number,
                            @QueryParam("limit") @DefaultValue("-1") Integer limit,
                            // TODO: convert it all to boolean and convert it into string?
                            @QueryParam("null_values") @DefaultValue("false") Boolean null_values,
                            @QueryParam("show_codes") @DefaultValue("true") Boolean show_codes,
                            @QueryParam("show_flags") @DefaultValue("true") Boolean show_flags,
                            @QueryParam("show_unit") @DefaultValue("true") Boolean show_unit,
                            @QueryParam("pivot") @DefaultValue("false") Boolean pivot,
                            @QueryParam("no_records") @DefaultValue("false") Boolean no_records,
                            @Context UriInfo uriInfo) {

        try {

            long t0 = System.currentTimeMillis();

            FAOSTATAPICore faostatapiCore = new FAOSTATAPICore();

            // Getting DomainCodes (in theory should be one)
            List<String> domainCodes = new ArrayList<String>() {{addAll(Arrays.asList(domainCode.split(",")));}};

            // setting the dimensions request bean
            MetadataBean dimensionsBean = new MetadataBean();
            dimensionsBean.storeUserOptions(datasource, api_key, client_key, output_type);
            dimensionsBean.addParameter("lang", faostatapiCore.iso2faostat(lang));
            dimensionsBean.addParameter("domain_code", domainCodes.get(0)); /* Get the first domain code, to get the dimensions later on. */

            // setting the data request bean
            final MetadataBean metadataBean = new MetadataBean();
            metadataBean.storeUserOptions(datasource, api_key, client_key, output_type);
            DatasourceBean datasourceBean = new DatasourceBean(metadataBean.getDatasource());
            metadataBean.addParameter("lang", faostatapiCore.iso2faostat(lang));
            metadataBean.addParameter("domain_code", domainCodes.get(0)); /* Get the first domain code, to get the dimensions later on. */
            //metadataBean.addParameter("domain_codes", domainCodes);
            metadataBean.addParameter("group_by", group_by);
            metadataBean.addParameter("order_by", order_by);
            metadataBean.addParameter("operator", operator);
            metadataBean.addParameter("page_size", page_size);
            if (decimal_places != null) {
                metadataBean.addParameter("decimal_places", decimal_places);
            }
            metadataBean.addParameter("page_number", page_number);
            metadataBean.addParameter("limit", limit);
            // this is because the procedure takes 0 and 1
            metadataBean.addParameter("show_codes", show_codes.booleanValue()? 1 : 0);
            metadataBean.addParameter("show_flags", show_flags.booleanValue()? 1 : 0);
            metadataBean.addParameter("show_unit", show_unit.booleanValue()? 1 : 0);
            metadataBean.addParameter("null_values", null_values);
            metadataBean.setPivot(pivot);

            // used for size
            metadataBean.addParameter("no_records", no_records.booleanValue()? 1 : 0);

            LOGGER.info("MetadataBean: " + metadataBean);

            // add filters parameters
            metadataBean.addParameters(getFilters(uriInfo.getQueryParameters(), datasourceBean, dimensionsBean));

            /* Stream builder. */
            final StreamBuilder sb = new StreamBuilder();

            // get DSD
            final List<Map<String, Object>> dsd = faostatapiCore.createDSD(datasourceBean, metadataBean);

            /* Query the DB and create an output stream. */
            String query = new QUERIES().getQuery("data_new", metadataBean.getProcedureParameters());

            final JDBCIterable it = new JDBCIterable();
            it.query(datasourceBean, query);

            // filter DSD
            final List<Map<String, Object>> dsdFiltered = FAOSTATAPIUtils.filterDSD(dsd, it.getColumnNames(), it.getColumnTypes());

            // statistics
            long tf = System.currentTimeMillis();
            metadataBean.setProcessingTime(tf - t0);

            StreamingOutput stream = new StreamingOutput() {

                @Override
                public void write(OutputStream os) throws IOException, WebApplicationException {

                    /* Initiate the buffer writer. */
                    Writer writer = new BufferedWriter(new OutputStreamWriter(os));

                    /* Generate an array of objects of arrays. */
                    switch (metadataBean.getOutputType()) {
                        case CSV:

                            writeCSV(it, writer);
                            break;

                        default:

                            writeJSON(sb, metadataBean, dsdFiltered, it, writer);
                            break;

                    }

                    /* Flush the writer. */
                    writer.flush();

                    /* Close the writer. */
                    writer.close();

                }

            };

            /* Stream result */
            return Response.ok(stream).type(FAOSTATAPIUtils.outputType(metadataBean)).build();


        } catch (WebApplicationException e) {
            return e.getResponse();
        } catch (Exception e) {
            return Response.status(500).entity(e.getMessage()).build();
        }

    }

    // get filters to be passed to the core
    private  Map<String, Object> getFilters(MultivaluedMap<String, String> params, DatasourceBean datasourceBean, MetadataBean metadataBean) throws Exception {

        FAOSTATAPICore faostatapiCore = new FAOSTATAPICore();
        Integer paramCounter = 1;

          /* getting domain dimensions */
        OutputBean ob = faostatapiCore.queryDimensions("dimensions", datasourceBean, metadataBean);
        Map<String, Object> filters = new HashMap<>();

        /* for each dimension tries to map to a filter */
        boolean validFilter = false;
        final String defaultCode = "_1";
        while (ob.getData().hasNext()) {

            Map<String, Object> dimension = ob.getData().next();

            String id = dimension.get("id").toString();

            // the "[]" is for the arrays passed on the GET ajax call
            List<String> codes = params.get(id) != null? params.get(id): params.get(id + "[]");

            // alternate coding system
            List<String> altCS = params.get(id + "_cs");

            String parameterVarType = "List"+ paramCounter +"VarType";
            String parameterListCodes = "List"+ paramCounter +"Codes";
            String parameterAltCodes = "List"+ paramCounter +"AltCodes";

            List<String> c = new ArrayList<String>() {{add(defaultCode);}};
            if (codes != null && !codes.isEmpty()) {
                for(String v : codes) {
                    if (!v.equals("")) {
                        c.addAll(Arrays.asList(v.split(",")));
                        validFilter = true;
                        c.remove(defaultCode);
                    }
                }
            }

            filters.put(parameterVarType, id);
            filters.put(parameterListCodes, c);

            if (altCS != null) {
                filters.put(parameterAltCodes, altCS.get(0));
            }

            paramCounter++;
        }

        if (!validFilter) {
            LOGGER.warn("Invalid request. Please add at least one filter.");
            throw new Exception("Please add at least one filter.");
        }

        LOGGER.info("Filters: "  + filters);

        return filters;
    }
}